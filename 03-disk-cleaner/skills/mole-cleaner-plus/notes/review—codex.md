# PLAN.md Review (Codex)

下面是对 `03-disk-cleaner/skills/mole-cleaner-plus/PLAN.md` 的 review 记录，重点关注风险、可落地性、边界与实现细节。

## 主要问题（按严重程度）

1. **安全边界过于宽泛**：`PROTECTED_PATHS` 已经排除了大量系统/云/配置目录，但核心功能仍要扫描 `~/Documents`、`~/Pictures` 等。需要强制默认只分析不删除，并将删除做成独立步骤或二次确认，否则“高情商设计”会被误解为可直接清理。
2. **Smart Folder 逻辑不完整**：`.savedSearch` 的 plist 结构过于简化，Finder 对字段敏感；仅 `RawQuery` + `SearchScopes` 可能无法生效。建议补充已验证模板，或提供 fallback（CSV 报告 + `mdfind` + `open`）。
3. **保护与扫描逻辑冲突**：当前是“白名单扫描 + 黑名单保护”混合模式，逻辑不一致。建议明确默认只扫描白名单路径，黑名单只用于用户手动扩展扫描范围时。
4. **删除策略未成体系**：没有明确使用哪种回收站策略、哪些类型“永不删除”的硬规则、以及警示/确认的强制流程。需把删除策略写进执行流程。
5. **依赖与性能风险未标注**：`--similar-photos` 需要额外依赖（如 `imagehash`、`PIL`、HEIC 支持），扫描大型图库可能非常慢；需标注性能预算、并行/缓存策略。

## 中等问题 / 可改进点

1. **`--stale` 判定逻辑不一致**：描述为 mtime + btime，但实现 `max(mtime_age, btime_age)` 会把“刚修改但创建较久”的文件判断为久未使用。建议改为 `min` 或以 mtime 为主。
2. **版本包识别误判风险**：仅靠文件名规则可能误删历史归档。建议限定下载目录，并加入“同名最新版本保留”的强约束。
3. **iOS 备份优先级与复杂度不匹配**：删除涉及权限/结构复杂度高。建议先做“分析+打开位置”，删除延后。
4. **微信/QQ 清理高风险**：目录结构变化与数据回收风险高。建议先做只读分析和引导，删除放后续版本。

## 轻微问题 / 文档一致性

1. **章节编号重复**：`2` 重复；建议统一。
2. **目录名混用**：`transript`/`transcript`，建议提示“以实际目录名为准”。
3. **CLI 例子缺少依赖说明**：建议标注 Python 版本与第三方库。

## 建议的调整方向（可行动）

- 明确三层模式：`analyze`（只读）、`plan`（生成清理方案/Smart Folder）、`apply`（明确删除，强确认）。
- Smart Folder 使用“已验证模板”或 `mdfind` 输出 + `open` 的 fallback。
- 删除策略明确化：仅回收站、危险文件强制二次确认、所有删除写日志。
- 高风险功能（微信/QQ、iMessage、邮件、Time Machine）先做“分析+引导”，删除放后续版本。
